---
- name: "Self Installation of Laptop"
  become: yes
  hosts: localhost
  ansible_python_interpreter: /usr/bin/python3
  roles:
  - Packages

  post_tasks:
  - name: Ajout des dépôts supplémentaires
    block:
    - name: Installation of Visual Studio Code
      shell:
        cmd: "{{ item }}"
      with_items:
      - wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg 
      - install -o root -g root -m 644 packages.microsoft.gpg /etc/apt/trusted.gpg.d/ 
      - sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/trusted.gpg.d/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/Visual_Studio_Code.list' 
      - rm -f packages.microsoft.gpg
    - name: Installation of the key for VirtualBox
      apt_key:
        url: "{{ item }}"
      with_items:
      - https://www.virtualbox.org/download/oracle_vbox.asc
      - https://www.virtualbox.org/download/oracle_vbox_2016.asc
    - name: Installation of repository for VirtualBox
      apt_repository:
        repo: "deb [arch=amd64] https://download.virtualbox.org/virtualbox/debian eoan contrib"
        filename: "Virtualbox"
    - name: Installation of Metasploit FrameWork
      shell:
        cmd: "{{ item }}"
      with_items:
      - curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall
      - chmod 755 msfinstall
      - bash msfinstall
    - name: Installation of Spotify's key
      apt_key:
        url: https://download.spotify.com/debian/pubkey_0D811D58.gpg
    - name: Installation of Spotify's repository
      apt_repository:
        repo: "deb http://repository.spotify.com stable non-free"
        filename: Spotify      
    tags:
    - repo
  - name: Installation et configuration GNS3
    block:
    - name: Installation GNS3 via pip
      pip:
        name: 
          - gns3-server
          - gns3-gui
    - name: Installation de la clef GNS3 pour le ppa pour VPC version 0.6.1
      shell:
        cmd: apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F88F6D313016330404F710FC9A2FD067A2E3EF7B
    - name: Installation du repo GNS3 pour le ppa pour VPC version 0.6.1
      apt_repository:
        codename: xenial
        filename: GNS3
        repo: deb http://ppa.launchpad.net/gns3/ppa/ubuntu xenial main
        update_cache: yes
    - name: Install VPCS in 0.6.1
      apt:
        update_cache: yes
        name: 
        - vpcs
        - dynamips
        - ubridge
    - name: Mark hold VPCS in 0.6.1
      dpkg_selections:
        name: vpcs
        selection: hold
    tags:
    - gns3
  - name: Installation des fonds d'écrans
    copy:
      src: Wallpapers
      dest: /home/theophile/Images

  - name: Add ansible-pull cron job
    cron:
      name: Ansible auto-provision
      user: root
      hour: "*/1"
      job: ansible-pull -o -U https://github.com/Eliora59/SelfInstall.git

  - name: Templétisation de .vimrc
    template:
      src: vimrc.j2
      dest: /home/theophile/.vimrc


        ##################################### Can't reboot Localhost, "Running reboot with local connection would reboot the control node"
        # - name: "Reboot of Laptop"
        #   reboot:
        #     msg: "Reboot from Ansible"
        #     reboot_timeout: 120
        #     test_command: uptime
        #   delegate_to: localhost